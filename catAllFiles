#!/usr/bin/env bash

# -----------------------------------------------------------------------------
# catAllFiles: Calls catFiles on all base names found in directories.
# -----------------------------------------------------------------------------
# Usage:
#   catAllFiles [--withSchema schema.prisma] <dir1> <dir2> <dir3> ...
#
# Example:
#   catAllFiles --withSchema prisma/schema.prisma prisma/seeds prisma/mutations src/resolvers/
# -----------------------------------------------------------------------------

if [ $# -lt 1 ]; then
    echo "Usage: $0 [--withSchema schema.prisma] <dir1> <dir2> ..."
    exit 1
fi

SCHEMA_FILE=""
DIRECTORIES=()

if [[ "$1" == "--withSchema" ]]; then
    SCHEMA_FILE="$2"
    shift 2
fi

DIRECTORIES=("$@")
OUTPUT_DIR=~/Downloads
mkdir -p "$OUTPUT_DIR"

for file in "${DIRECTORIES[0]}"/*; do
    if [[ -f "$file" ]]; then
        baseName=$(basename "$file" | cut -d '.' -f1)
        outputFile="$OUTPUT_DIR/${baseName}-code.ts"

        echo "Processing: $baseName"
        if [[ -n "$SCHEMA_FILE" ]]; then
            catFiles --grep "$baseName" --withSchema "$SCHEMA_FILE" "${DIRECTORIES[@]}" > "$outputFile"
        else
            catFiles --grep "$baseName" "${DIRECTORIES[@]}" > "$outputFile"
        fi

        [[ -s "$outputFile" ]] && echo "✅ Processed $baseName -> $outputFile" || echo "❌ Failed: $outputFile"
    fi
done

echo "Processing complete."
